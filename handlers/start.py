"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ /start –∏ /help
"""
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from database.crud import get_or_create_user, update_user_profile
from keyboards.category_kb import get_category_keyboard
from config import DRIVER_TYPES, DEFAULT_TIME_VALUES

router = Router()


@router.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_obj = message.from_user
    user = await get_or_create_user(user_obj.id, user_obj.username)
    
    # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å
    driver_type = user.get("driver_type")
    if not driver_type:
        welcome_text = """
üöó –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FuelIntelliBot!

–Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –∑–∞–ø—Ä–∞–≤–∫—É —Å —É—á–µ—Ç–æ–º:
‚Ä¢ –¶–µ–Ω—ã —Ç–æ–ø–ª–∏–≤–∞
‚Ä¢ –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –ê–ó–°
‚Ä¢ –†–∞—Å—Ö–æ–¥–∞ –Ω–∞ –¥–æ—Ä–æ–≥—É
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

üìã –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤–æ–¥–∏—Ç–µ–ª—è:
"""
        await message.answer(welcome_text, reply_markup=get_category_keyboard())
    else:
        driver_name = DRIVER_TYPES.get(driver_type, driver_type)
        welcome_text = f"""
üöó –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FuelIntelliBot!

–í–∞—à–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {driver_name}

üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/fuel <—Ç–∏–ø> <–ª–∏—Ç—Ä—ã> - —Ä–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –∑–∞–ø—Ä–∞–≤–∫–∏
/profile - –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è
/balance - –≤—ã–±–æ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π)
/compare <—Ç–∏–ø> <–ª–∏—Ç—Ä—ã> - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
/help - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

–ü—Ä–∏–º–µ—Ä: /fuel 95 40
"""
        await message.answer(welcome_text)


@router.callback_query(F.data.startswith("category_"))
async def process_category(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è"""
    category = callback.data.split("_")[1]
    
    if category not in DRIVER_TYPES:
        await callback.answer("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è", show_alert=True)
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    time_value = DEFAULT_TIME_VALUES.get(category, 10.0)
    await update_user_profile(
        callback.from_user.id,
        driver_type=category,
        time_value=time_value
    )
    
    category_name = DRIVER_TYPES.get(category, category)
    
    text = f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è: {category_name}\n\n"
    
    if category == "regular":
        text += "üí° –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π –¥–æ—Å—Ç—É–ø–Ω—ã –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞:\n"
        text += "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è\n"
        text += "‚Ä¢ –ë–ª–∏–∑–∫–∞—è –∏ –≤—ã–≥–æ–¥–Ω–∞—è\n\n"
        text += "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: /balance\n"
    else:
        text += "üí° –ë–æ—Ç –ø–æ–¥–±–µ—Ä–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤–∞—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n"
    
    text += "\nüìã –ù–∞—á–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç: /fuel 95 40"
    
    await callback.message.edit_text(text)
    await callback.answer()


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
üìñ –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:

üöó –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´:

/fuel <—Ç–∏–ø> <–ª–∏—Ç—Ä—ã> - —Ä–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –∑–∞–ø—Ä–∞–≤–∫–∏
  –ü—Ä–∏–º–µ—Ä—ã:
    /fuel 95 40
    /fuel 92 50
    /fuel –¥—Ç 60

/profile - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

/balance - –≤—ã–±–æ—Ä –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π)

/compare <—Ç–∏–ø> <–ª–∏—Ç—Ä—ã> - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ê–ó–°

üìã –ö–ê–¢–ï–ì–û–†–ò–ò –í–û–î–ò–¢–ï–õ–ï–ô:

üöï –¢–∞–∫—Å–∏—Å—Ç - –º–∏–Ω–∏–º—É–º –≤—Ä–µ–º–µ–Ω–∏, –±–ª–∏–∂–∞–π—à–∏–µ –ê–ó–°
üöó –û–±—ã—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å - –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ (—ç–∫–æ–Ω–æ–º–∏—è + –±–∞–ª–∞–Ω—Å)
üó∫Ô∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫ - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫
üí∞ –ë—é–¥–∂–µ—Ç–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è

üí° –û–°–û–ë–ï–ù–ù–û–°–¢–ò:

–î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:
‚Ä¢ –í–∞—Ä–∏–∞–Ω—Ç –ê: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è (–¥–∞–ª—å—à–µ, –Ω–æ –¥–µ—à–µ–≤–ª–µ)
‚Ä¢ –í–∞—Ä–∏–∞–Ω—Ç –ë: –ë–ª–∏–∑–∫–∞—è –∏ –≤—ã–≥–æ–¥–Ω–∞—è (–∫–æ–º–ø—Ä–æ–º–∏—Å—Å)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–æ–º–∞–Ω–¥–æ–π /balance:
‚Ä¢ üí∞ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è
‚Ä¢ ‚öñÔ∏è –ë–∞–ª–∞–Ω—Å —Ü–µ–Ω—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
‚Ä¢ üè† –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–¥–æ–±—Å—Ç–≤–æ

üìä –†–ê–°–ß–ï–¢ –£–ß–ò–¢–´–í–ê–ï–¢:
‚Ä¢ –¶–µ–Ω—É —Ç–æ–ø–ª–∏–≤–∞
‚Ä¢ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ê–ó–°
‚Ä¢ –†–∞—Å—Ö–æ–¥ –Ω–∞ –¥–æ—Ä–æ–≥—É
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
‚Ä¢ –°–∫–∏–¥–∫–∏ –ø–æ –∫–∞—Ä—Ç–∞–º –∏ –¥–∏—Å–∫–æ–Ω—Ç—ã

üí≥ –î–ò–°–ö–û–ù–¢–´:
/discounts - –≤–∞—à–∏ –¥–∏—Å–∫–æ–Ω—Ç—ã
/discounts_list - —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏—Å–∫–æ–Ω—Ç–æ–≤
/discounts_add <ID> - –¥–æ–±–∞–≤–∏—Ç—å –¥–∏—Å–∫–æ–Ω—Ç
/discounts_remove <ID> - —É–¥–∞–ª–∏—Ç—å –¥–∏—Å–∫–æ–Ω—Ç

üí° –î–∏—Å–∫–æ–Ω—Ç—ã –º–æ–≥—É—Ç —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –∏–ª–∏ –±—Ä–∞—Ç—å—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞)
"""
    await message.answer(help_text)

